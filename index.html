<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drzewko Umiejętności</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            color: white;
            font-family: Arial, sans-serif;
        }
        #confirmation {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        #confirmation button {
            margin: 10px;
            padding: 10px;
            background-color: #333;
            border: none;
            color: white;
            cursor: pointer;
        }
        #confirmation button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="confirmation">
        <p id="confirmationText"></p>
        <button id="continue">Kontynuuj</button>
        <button id="cancel">Anuluj</button>
    </div>

    <script>
        let nodes = [];
        let connections = [];
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let lastX, lastY;
        let activeConnections = [];
        let learnedSkills = new Set();
        let blockedSkills = new Set();
        let isModalOpen = false;

        let skillBlocks = {
    "Farmer T3": ["Mielarz T2", "Mielarz T3","Cieśla T1","Cieśla T2","Cieśla T3","Hutnik T1","Hutnik T2","Hutnik T3"],
    "Farmer T2": ["Miecznik T5", "Płatnerz T5", "Kuśnierz T5", "Kaletnik T5"],
    "Mielarz T1": ["Drwal T3","Górnik T3","Hutnik T3","Hutnik T2","Hutnik T1", "Cieśla T1", "Cieśla T2", "Cieśla T3","Miecznik T5","Płatnerz T5","Kuśnierz T5", "Kaletnik T5","Hutnik T3"],
    "Mielarz T3":["Farmer T3"],
    "Farmer T3":["Mielarz T3"],
    "Farmer T3":["Mielarz T3"],
    "Farmer T1":["Mielarz T3", "Cieśla T3","Hutnik T3"],
    "Farmer T3 + Mielarz T2": ["Drwal T2", "Górnik T2"],
    "Farmer T2 + Mielarz T3": ["Drwal T2", "Górnik T2"],
    "Farmer T3 + Farmer T2": ["Miecznik T4", "Płatnerz T4", "Kuśnierz T4", "Kaletnik T4"],
    "Farmer T1 + Mielarz T1": ["Miecznik T4", "Płatnerz T4", "Kuśnierz T4", "Kaletnik T4"],
    "Farmer T2 + Mielarz T1": ["Miecznik T3", "Płatnerz T3", "Kuśnierz T3", "Kaletnik T3"],
    "Farmer T1 + Mielarz T2": ["Miecznik T3", "Płatnerz T3", "Kuśnierz T3", "Kaletnik T3"],
    "Farmer T3 + Mielarz T2 + Drwal T1": ["Miecznik T2", "Płatnerz T2", "Kuśnierz T2", "Kaletnik T2"],
    "Farmer T3 + Mielarz T2 + Drwal T1 + Górnik T1": ["Kowal","Krawiec","Miecznik T1","Płatnerz T1","Kuśnierz T1","Kaletnik T1"],
    "Farmer T3 + Mielarz T2 + Kowal": ["Krawiec","Kuśnierz T1", "Kuśnierz T2", "Kaletnik T1","Kaletnik T2"],
    "Farmer T3 + Mielarz T2 + Krawiec": ["Kowal","Miecznik T1", "Miecznik T2", "Płatnerz T1","Płatnerz T2"],

    "Płatnerz T2" : ["Mielarz T3","Cieśla T3","Hutnik T3"],
    "Płatnerz T3" : ["Miecznik T5","Kuśnierz T5","Kaletnik T5","Mielarz T2","Cieśla T2","Hutnik T2","Farmer T3","Drwal T3","Górnik T3"],
    "Płatnerz T4" : ["Miecznik T4","Kuśnierz T4","Kaletnik T4","Mielarz T1","Cieśla T1","Hutnik T1","Farmer T2","Drwal T2","Górnik T2"],
    "Płatnerz T5" : ["Miecznik T3","Kuśnierz T3","Kaletnik T3"],
    "Płatnerz T5" : ["Miecznik T3","Kuśnierz T3","Kaletnik T3"],
    "Płatnerz T5 + Miecznik T1" : ["Kuśnierz T2","Kaletnik T2"],
    "Płatnerz T5 + Miecznik T2" : ["Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Płatnerz T5 + Miecznik T1 + Farmer T1" : ["Drwal T1","Górnik T1","Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Płatnerz T5 + Miecznik T1 + Drwal T1" : ["Farmer T1","Górnik T1","Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Płatnerz T5 + Miecznik T1 + Górnik T1" : ["Drwal T1","Górnik T1","Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Płatnerz T5 + Miecznik T1 + Kuśnierz T1" : ["Drwal T1","Górnik T1","Farmer T1","Kaletnik T1","Robotnik"],
    "Płatnerz T5 + Miecznik T1 + Kaletnik T1" : ["Drwal T1","Górnik T1","Farmer T1","Kuśnierz T1","Robotnik"],

    "Miecznik T2" : ["Kuśnierz T5","Kuśnierz T5","Kaletnik T5","Mielarz T3","Cieśla T3","Hutnik T3"],
    "Miecznik T3" : ["Płatnerz T5","Kuśnierz T4","Kaletnik T4","Mielarz T2","Cieśla T2","Hutnik T2","Farmer T3","Drwal T3","Górnik T3"],
    "Miecznik T4" : ["Płatnerz T4","Kuśnierz T3","Kaletnik T3","Mielarz T1","Cieśla T1","Hutnik T1","Farmer T2","Drwal T2","Górnik T2"],
    "Miecznik T5" : ["Płatnerz T3","Kuśnierz T2","Kaletnik T2"],
    "Miecznik T5 + Płatnerz T1" : ["Kuśnierz T2","Kaletnik T2"],
    "Miecznik T5 + Płatnerz T2" : ["Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Miecznik T5 + Płatnerz T1 + Farmer T1" : ["Drwal T1","Górnik T1","Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Miecznik T5 + Płatnerz T1 + Drwal T1" : ["Farmer T1","Górnik T1","Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Miecznik T5 + Płatnerz T1 + Górnik T1" : ["Drwal T1","Farmer T1","Kuśnierz T1","Kaletnik T1","Krawiec"],
    "Miecznik T5 + Płatnerz T1 + Kuśnierz T1" : ["Drwal T1","Górnik T1","Farmer T1","Kaletnik T1","Robotnik"],
    "Miecznik T5 + Płatnerz T1 + Kaletnik T1" : ["Drwal T1","Górnik T1","Farmer T1","Kuśnierz T1","Robotnik"],


};

        let icons = {
            "Gołodupiec": "https://cdn.discordapp.com/avatars/472993187183591425/a_a2337b68637c7195080952341f92d3b5.gif?size=2048",
        };

        function preload() {
            for (let label in icons) {
                icons[label] = loadImage(icons[label]);
            }
        }

        function setup() {
            createCanvas(windowWidth, windowHeight);

            let start = new Node(0, 0, "Gołodupiec");
            nodes.push(start);
            learnedSkills.add(start.label);

            let professions = ["Kowal", "Robotnik", "Krawiec"];
            let offsets = [
                {x: -width / 4, y: height / 4},
                {x: 0, y: height / 4},
                {x: width / 4, y: height / 4}
            ];

            let kowalNode, robotnikNode, krawiecNode;
            for (let i = 0; i < professions.length; i++) {
                let node = new Node(offsets[i].x, offsets[i].y, professions[i]);
                nodes.push(node);
                connections.push([start, node]);
                if (professions[i] === "Kowal") kowalNode = node;
                if (professions[i] === "Robotnik") robotnikNode = node;
                if (professions[i] === "Krawiec") krawiecNode = node;
            }

            let jobs = ["Farmer", "Mielarz", "Drwal", "Cieśla", "Górnik", "Hutnik"];
            let jobNodes = [];
            let jobOffsetY = 150;
            let jobSpacing = 100;

            for (let i = 0; i < jobs.length; i++) {
                let node = new Node(robotnikNode.x + (i - 2.5) * jobSpacing, robotnikNode.y + jobOffsetY, jobs[i] + " T1");
                nodes.push(node);
                connections.push([robotnikNode, node]);
                jobNodes.push(node);
            }

            let tierOffsetY = 150;
            for (let job of jobNodes) {
                for (let tier = 2; tier <= 3; tier++) {
                    let node = new Node(job.x, job.y + tierOffsetY, job.label.split(" ")[0] + " T" + tier);
                    nodes.push(node);
                    connections.push([job, node]);
                    job = node;
                }
            }

            let kowalSkills = ["Miecznik", "Płatnerz"];
            let kowalOffsetX = -150;
            let kowalNodes = [];

            for (let i = 0; i < kowalSkills.length; i++) {
                let node = new Node(kowalNode.x + kowalOffsetX, kowalNode.y + jobOffsetY, kowalSkills[i] + " T1");
                nodes.push(node);
                connections.push([kowalNode, node]);
                kowalNodes.push(node);
                kowalOffsetX += 100;
            }

            for (let kowalJob of kowalNodes) {
                for (let tier = 2; tier <= 5; tier++) {
                    let node = new Node(kowalJob.x, kowalJob.y + tierOffsetY, kowalJob.label.split(" ")[0] + " T" + tier);
                    nodes.push(node);
                    connections.push([kowalJob, node]);
                    kowalJob = node;
                }
            }

            let krawiecSkills = ["Kuśnierz", "Kaletnik"];
            let krawiecOffsetX = 50;
            let krawiecNodes = [];

            for (let i = 0; i < krawiecSkills.length; i++) {
                let node = new Node(krawiecNode.x + krawiecOffsetX, krawiecNode.y + jobOffsetY, krawiecSkills[i] + " T1");
                nodes.push(node);
                connections.push([krawiecNode, node]);
                krawiecNodes.push(node);
                krawiecOffsetX += 100;
            }

            for (let krawiecJob of krawiecNodes) {
                for (let tier = 2; tier <= 5; tier++) {
                    let node = new Node(krawiecJob.x, krawiecJob.y + tierOffsetY, krawiecJob.label.split(" ")[0] + " T" + tier);
                    nodes.push(node);
                    connections.push([krawiecJob, node]);
                    krawiecJob = node;
                }
            }
        }

        function draw() {
    background(20);
    translate(width / 2 + offsetX, height / 2 + offsetY);
    stroke(200);

    for (let conn of connections) {
        let opacity = 255;
        if (isSkillBlocked(conn[0].label) || isSkillBlocked(conn[1].label)) {
            opacity = 50;
        }
        strokeWeight(1);
        stroke(200, opacity);
        line(conn[0].x, conn[0].y, conn[1].x, conn[1].y);
    }

    for (let node of nodes) {
        let opacity = 255;
        if (isSkillBlocked(node.label)) {
            opacity = 50;
        }
        fill(node.isActive ? 'red' : `rgba(173, 216, 230, ${opacity / 255})`);
        stroke(node.isActive ? 255 : 255);
        strokeWeight(node.isActive ? 3 : 1);
        ellipse(node.x, node.y, 40);

        if (icons[node.label]) {
            let iconOpacity = isSkillBlocked(node.label) ? 50 : 255;

            drawingContext.save();
            drawingContext.beginPath(); 
            drawingContext.arc(node.x, node.y, 15, 0, TWO_PI); 
            drawingContext.clip(); 

            imageMode(CENTER);
            tint(255, iconOpacity);
            image(icons[node.label], node.x, node.y, 50, 50);
            noTint();

            drawingContext.restore();
        }

        fill(255, opacity);
        noStroke();
        textAlign(CENTER, CENTER);
        textSize(12);
        text(node.label, node.x, node.y - 30);

        if (isSkillBlocked(node.label)) {
            stroke(255, 0, 0);
            strokeWeight(3);
            line(node.x - 20, node.y - 20, node.x + 20, node.y + 20);
            line(node.x - 20, node.y + 20, node.x + 20, node.y - 20);
        }
    }
}

        function mousePressed() {
            if (isModalOpen) return;

            if (mouseButton === RIGHT) {
                isDragging = true;
                lastX = mouseX;
                lastY = mouseY;
            }

            if (mouseButton === LEFT) {
                for (let node of nodes) {
                    let d = dist(mouseX - offsetX, mouseY - offsetY, node.x + width / 2, node.y + height / 2);
                    if (d < 20) {
                        handleLearning(node);
                        break;
                    }
                }
            }
        }

        function mouseReleased() {
            if (mouseButton === RIGHT) {
                isDragging = false;
            }
        }

        function mouseDragged() {
            if (isModalOpen) return;

            if (isDragging) {
                let dx = mouseX - lastX;
                let dy = mouseY - lastY;

                for (let node of nodes) {
                    node.x += dx;
                    node.y += dy;
                }

                lastX = mouseX;
                lastY = mouseY;
            }
        }

        document.addEventListener('contextmenu', function(event) {
            event.preventDefault();
        });

        function handleLearning(node) {
            if (learnedSkills.has(node.label)) {
                return;
            }

            if (isSkillBlocked(node.label)) {
                showMessage("Nie możesz nauczyć się tej umiejętności, ponieważ została zablokowana.");
                return;
            }

            let parent = getParent(node);
            if (parent && !learnedSkills.has(parent.label)) {
                showMessage("Nie możesz nauczyć się tej umiejętności, ponieważ nie nauczyłeś się poprzedniej.");
                return;
            }

            showConfirmation(node);
        }

        function isSkillBlocked(skill) {
            for (let learnedSkill of learnedSkills) {
                if (skillBlocks[learnedSkill] && skillBlocks[learnedSkill].includes(skill)) {
                    return blockedSkills.has(skill);
                }
            }

            for (let condition in skillBlocks) {
                if (condition.includes("+")) {
                    let requiredSkills = condition.split(" + ");
                    let allSkillsLearned = requiredSkills.every(skill => learnedSkills.has(skill));
                    if (allSkillsLearned && skillBlocks[condition].includes(skill)) {
                        return blockedSkills.has(skill);
                    }
                }
            }

            return false;
        }

        function getParent(node) {
            for (let conn of connections) {
                if (conn[1] === node) {
                    return conn[0];
                }
            }
            return null;
        }

        function showMessage(message) {
            const confirmationDiv = document.getElementById('confirmation');
            document.getElementById('confirmationText').textContent = message;
            confirmationDiv.style.display = 'block';
            document.getElementById('continue').style.display = 'none';
            document.getElementById('cancel').textContent = "OK";

            isModalOpen = true;

            document.getElementById('cancel').onclick = function() {
                confirmationDiv.style.display = 'none';
                document.getElementById('continue').style.display = 'inline-block';
                isModalOpen = false;
            };
        }

        function showConfirmation(node) {
            const confirmationDiv = document.getElementById('confirmation');
            document.getElementById('confirmationText').textContent =
                "Nauka tej dziedziny może zablokować dostęp do innych lub mocno ograniczyć ich rozwój. Czy na pewno chcesz kontynuować?";
            confirmationDiv.style.display = 'block';

            isModalOpen = true;

            document.getElementById('continue').style.display = 'inline-block';
            document.getElementById('cancel').textContent = "Anuluj";

            document.getElementById('continue').onclick = function() {
                learnSkill(node);
                confirmationDiv.style.display = 'none';
                isModalOpen = false;
            };

            document.getElementById('cancel').onclick = function() {
                confirmationDiv.style.display = 'none';
                isModalOpen = false;
            };
        }

        function learnSkill(node) {
            learnedSkills.add(node.label);

            if (skillBlocks[node.label]) {
                for (let blockedSkill of skillBlocks[node.label]) {
                    blockedSkills.add(blockedSkill);
                }
            }

            for (let condition in skillBlocks) {
                if (condition.includes("+")) {
                    let requiredSkills = condition.split(" + ");
                    let allSkillsLearned = requiredSkills.every(skill => learnedSkills.has(skill));
                    if (allSkillsLearned) {
                        for (let blockedSkill of skillBlocks[condition]) {
                            blockedSkills.add(blockedSkill);
                        }
                    }
                }
            }

            for (let conn of connections) {
                if (conn[1] === node) {
                    activeConnections.push(conn);
                }
            }
            node.isActive = true;
        }

        class Node {
            constructor(x, y, label) {
                this.x = x;
                this.y = y;
                this.label = label;
                this.isActive = label === "Gołodupiec";
            }
        }
    </script>
</body>
</html>